<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWEB Mempool - Fleet Credits Developer Documentation</title>
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="docs-container">
        <!-- Sidebar Navigation -->
<aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üöÄ</span>
                    <span class="logo-text">Fleet Credits</span>
                </div>
                <div class="version">v1.0.0 - Core</div>
                <div class="tagline">Scrypt PoW Blockchain with Contribution Rewards & MWEB Privacy</div>
                <div class="subtagline">‚ú® Complete Developer Documentation</div>
            </div>

            <div class="search-box">
                <input type="text" placeholder="Search documentation..." id="searchInput">
            </div>

            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">GETTING STARTED</div>
                    <a href="../index.html" class="nav-item">
                        <span class="nav-icon">üè†</span>
                        <span>Overview</span>
                    </a>
                    <a href="architecture.html" class="nav-item">
                        <span class="nav-icon">üèõÔ∏è</span>
                        <span>Architecture</span>
                    </a>
                    <a href="network-params.html" class="nav-item">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Network Parameters</span>
                    </a>
                    <a href="building.html" class="nav-item">
                        <span class="nav-icon">üî®</span>
                        <span>Building & Setup</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">CORE BLOCKCHAIN</div>
                    <a href="blockchain-core.html" class="nav-item">
                        <span class="nav-icon">‚õìÔ∏è</span>
                        <span>Block & Transaction</span>
                    </a>
                    <a href="utxo-model.html" class="nav-item">
                        <span class="nav-icon">üíé</span>
                        <span>UTXO Model</span>
                    </a>
                    <a href="consensus.html" class="nav-item">
                        <span class="nav-icon">üîê</span>
                        <span>Consensus & PoW</span>
                    </a>
                    <a href="validation.html" class="nav-item">
                        <span class="nav-icon">‚úÖ</span>
                        <span>Validation System</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">CONTRIBUTION SYSTEM</div>
                    <a href="contribution-overview.html" class="nav-item">
                        <span class="nav-icon">üéØ</span>
                        <span>Contribution Overview</span>
                    </a>
                    <a href="contribution-types.html" class="nav-item">
                        <span class="nav-icon">üìã</span>
                        <span>Contribution Types</span>
                    </a>
                    <a href="contribution-rewards.html" class="nav-item">
                        <span class="nav-icon">üí∞</span>
                        <span>Reward System</span>
                    </a>
                    <a href="verification-system.html" class="nav-item">
                        <span class="nav-icon">üîç</span>
                        <span>Verification System</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">MWEB PRIVACY</div>
                    <a href="mweb-overview.html" class="nav-item">
                        <span class="nav-icon">üîí</span>
                        <span>MWEB Overview</span>
                    </a>
                    <a href="mweb-structures.html" class="nav-item">
                        <span class="nav-icon">üèóÔ∏è</span>
                        <span>MWEB Structures</span>
                    </a>
                    <a href="mweb-operations.html" class="nav-item">
                        <span class="nav-icon">‚ö°</span>
                        <span>Peg-in/Peg-out</span>
                    </a>
                    <a href="mweb-mempool.html" class="nav-item active">
                        <span class="nav-icon">üì¶</span>
                        <span>MWEB Mempool</span>
                    </a>
                    <a href="mweb-implementation-status.html" class="nav-item">
                        <span class="nav-icon">‚úÖ</span>
                        <span>Implementation Status</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">RPC API</div>
                    <a href="rpc-overview.html" class="nav-item">
                        <span class="nav-icon">üì°</span>
                        <span>RPC Overview</span>
                    </a>
                    <a href="rpc-contribution.html" class="nav-item">
                        <span class="nav-icon">üì§</span>
                        <span>Contribution RPC</span>
                    </a>
                    <a href="rpc-mweb.html" class="nav-item">
                        <span class="nav-icon">üîê</span>
                        <span>MWEB RPC</span>
                    </a>
                    <a href="rpc-mining.html" class="nav-item">
                        <span class="nav-icon">‚õèÔ∏è</span>
                        <span>Mining RPC</span>
                    </a>
                    <a href="rpc-wallet.html" class="nav-item">
                        <span class="nav-icon">üëõ</span>
                        <span>Wallet RPC</span>
                    </a>
                    <a href="rpc-blockchain.html" class="nav-item">
                        <span class="nav-icon">‚õìÔ∏è</span>
                        <span>Blockchain RPC</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">WALLET SYSTEM</div>
                    <a href="wallet-overview.html" class="nav-item">
                        <span class="nav-icon">üëõ</span>
                        <span>Wallet Overview</span>
                    </a>
                    <a href="wallet-classes.html" class="nav-item">
                        <span class="nav-icon">üì¶</span>
                        <span>Wallet Classes</span>
                    </a>
                    <a href="address-system.html" class="nav-item">
                        <span class="nav-icon">üìç</span>
                        <span>Address System</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">QT GUI</div>
                    <a href="qt-overview.html" class="nav-item">
                        <span class="nav-icon">üñ•Ô∏è</span>
                        <span>GUI Overview</span>
                    </a>
                    <a href="qt-components.html" class="nav-item">
                        <span class="nav-icon">üß©</span>
                        <span>Components</span>
                    </a>
                    <a href="qt-models.html" class="nav-item">
                        <span class="nav-icon">üìä</span>
                        <span>Models</span>
                    </a>
                    <a href="qt-themes.html" class="nav-item">
                        <span class="nav-icon">üé®</span>
                        <span>Themes</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">FEE STRUCTURE</div>
                    <a href="fee-system.html" class="nav-item">
                        <span class="nav-icon">üíµ</span>
                        <span>Fee System</span>
                    </a>
                    <a href="community-reserve.html" class="nav-item">
                        <span class="nav-icon">üè¶</span>
                        <span>Community Reserve</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">TESTING</div>
                    <a href="testing-overview.html" class="nav-item">
                        <span class="nav-icon">üß™</span>
                        <span>Testing Overview</span>
                    </a>
                    <a href="test-structures.html" class="nav-item">
                        <span class="nav-icon">üìù</span>
                        <span>Test Structures</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">REFERENCE</div>
                    <a href="erd-diagram.html" class="nav-item">
                        <span class="nav-icon">üìê</span>
                        <span>ERD Diagram</span>
                    </a>
                    <a href="naming-conventions.html" class="nav-item">
                        <span class="nav-icon">üìù</span>
                        <span>Naming Conventions</span>
                    </a>
                    <a href="api-reference.html" class="nav-item">
                        <span class="nav-icon">üìö</span>
                        <span>Complete API Reference</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1>MWEB Mempool</h1>
                <p class="subtitle">In-memory pool for pending MWEB transactions, peg-ins, and peg-outs</p>
            </div>

            <section class="content-section">
                <h2>Overview</h2>
                <p>The <strong>MWEB Mempool</strong> (<code>CMWEBMempool</code>) is an in-memory data structure that stores pending MWEB transactions, peg-in transactions, and peg-out transactions waiting to be included in the next MWEB extension block.</p>
                
                <div class="note">
                    <strong>Purpose:</strong> Similar to the main chain mempool, the MWEB mempool temporarily stores unconfirmed MWEB transactions. When a miner creates a new block, they collect transactions from the MWEB mempool and include them in the MWEB extension block.
                </div>
                
                <p><strong>File:</strong> <code>src/mweb_mempool.h</code>, <code>src/mweb_mempool.cpp</code></p>
            </section>

            <section class="content-section">
                <h2>Class Structure</h2>
                
                <h3>CMWEBMempool</h3>
                <pre><code>class CMWEBMempool {
private:
    CCriticalSection cs_mweb_mempool;  // Thread safety
    
    // Pending MWEB transactions
    std::map&lt;uint256, CMWEBTransaction&gt; mweb_txs;
    
    // Pending peg-in transactions
    std::map&lt;uint256, CPegInTransaction&gt; peg_ins;
    
    // Pending peg-out transactions
    std::map&lt;uint256, CPegOutTransaction&gt; peg_outs;

public:
    // MWEB Transaction Methods
    bool AddMWEBTransaction(const CMWEBTransaction& tx);
    bool RemoveMWEBTransaction(const uint256& txid);
    std::vector&lt;CMWEBTransaction&gt; GetMWEBTransactions() const;
    
    // Peg-in Methods
    bool AddPegIn(const CPegInTransaction& peg_in);
    bool RemovePegIn(const uint256& peg_tx_id);
    std::vector&lt;CPegInTransaction&gt; GetPegIns() const;
    
    // Peg-out Methods
    bool AddPegOut(const CPegOutTransaction& peg_out);
    bool RemovePegOut(const uint256& peg_tx_id);
    std::vector&lt;CPegOutTransaction&gt; GetPegOuts() const;
    
    // Utility Methods
    void Clear();
    size_t Size() const;
};</code></pre>
                
                <h3>Global Instance</h3>
                <p>A global instance is available throughout the codebase:</p>
                <pre><code>extern CMWEBMempool mwebMempool;</code></pre>
            </section>

            <section class="content-section">
                <h2>Data Storage</h2>
                
                <h3>MWEB Transactions</h3>
                <p>Standard MWEB transactions (privacy transactions) are stored in <code>mweb_txs</code>:</p>
                <ul>
                    <li><strong>Key:</strong> Transaction hash (<code>uint256</code>)</li>
                    <li><strong>Value:</strong> <code>CMWEBTransaction</code> object</li>
                    <li><strong>Purpose:</strong> Stores pending MWEB transactions waiting for block inclusion</li>
                </ul>
                
                <h3>Peg-in Transactions</h3>
                <p>Peg-in transactions (main chain ‚Üí MWEB) are stored in <code>peg_ins</code>:</p>
                <ul>
                    <li><strong>Key:</strong> Peg transaction ID (<code>uint256</code>)</li>
                    <li><strong>Value:</strong> <code>CPegInTransaction</code> object</li>
                    <li><strong>Purpose:</strong> Stores pending peg-ins waiting for MWEB extension block creation</li>
                </ul>
                
                <h3>Peg-out Transactions</h3>
                <p>Peg-out transactions (MWEB ‚Üí main chain) are stored in <code>peg_outs</code>:</p>
                <ul>
                    <li><strong>Key:</strong> Peg transaction ID (<code>uint256</code>)</li>
                    <li><strong>Value:</strong> <code>CPegOutTransaction</code> object</li>
                    <li><strong>Purpose:</strong> Stores pending peg-outs waiting for MWEB extension block creation</li>
                </ul>
            </section>

            <section class="content-section">
                <h2>Thread Safety</h2>
                <p>The MWEB mempool uses <code>CCriticalSection</code> (<code>cs_mweb_mempool</code>) to ensure thread-safe access:</p>
                
                <ul>
                    <li><strong>All operations are protected:</strong> Add, remove, and get operations use <code>LOCK(cs_mweb_mempool)</code></li>
                    <li><strong>Concurrent access safe:</strong> Multiple threads can safely access the mempool</li>
                    <li><strong>No race conditions:</strong> Critical section prevents data corruption</li>
                </ul>
                
                <h3>Example Usage</h3>
                <pre><code>// Add MWEB transaction (thread-safe)
{
    LOCK(cs_mweb_mempool);
    mweb_txs[tx.tx_hash] = tx;
}

// Get all MWEB transactions (thread-safe)
std::vector&lt;CMWEBTransaction&gt; GetMWEBTransactions() const {
    LOCK(cs_mweb_mempool);
    std::vector&lt;CMWEBTransaction&gt; result;
    for (const auto& pair : mweb_txs) {
        result.push_back(pair.second);
    }
    return result;
}</code></pre>
            </section>

            <section class="content-section">
                <h2>Transaction Lifecycle</h2>
                
                <h3>1. Transaction Creation</h3>
                <p>When a user creates an MWEB transaction (via RPC or wallet):</p>
                <ol>
                    <li>Transaction is created with proper commitments and range proofs</li>
                    <li>Balance and range proofs are verified</li>
                    <li>Transaction is added to mempool via <code>AddMWEBTransaction()</code></li>
                </ol>
                
                <h3>2. Mempool Storage</h3>
                <p>Transaction remains in mempool until:</p>
                <ul>
                    <li>Included in a block (removed automatically)</li>
                    <li>Expired due to time limits</li>
                    <li>Replaced by a higher-fee version</li>
                </ul>
                
                <h3>3. Block Inclusion</h3>
                <p>When a miner creates a new block:</p>
                <ol>
                    <li>Miner calls <code>GetMWEBTransactions()</code>, <code>GetPegIns()</code>, <code>GetPegOuts()</code></li>
                    <li>Transactions are added to MWEB extension block</li>
                    <li>After block is connected, <code>RemoveMWEBTransaction()</code> is called for each transaction</li>
                    <li>Mempool is cleared of included transactions</li>
                </ol>
            </section>

            <section class="content-section">
                <h2>Integration Points</h2>
                
                <h3>RPC Commands</h3>
                <p>RPC commands interact with the MWEB mempool:</p>
                <ul>
                    <li><code>createpegin</code>: Adds peg-in to mempool</li>
                    <li><code>createpegout</code>: Adds peg-out to mempool</li>
                    <li><code>routecontributiontomweb</code>: Adds MWEB transaction to mempool</li>
                    <li><code>listmwebtxs</code>: Lists transactions from mempool and blocks</li>
                </ul>
                
                <h3>Miner Integration</h3>
                <p>In <code>miner.cpp</code>, <code>CreateNewBlock()</code>:</p>
                <ol>
                    <li>Collects pending MWEB transactions from mempool</li>
                    <li>Collects pending peg-ins and peg-outs</li>
                    <li>Includes them in MWEB extension block</li>
                    <li>Applies cut-through optimization</li>
                </ol>
                
                <h3>Validation Integration</h3>
                <p>In <code>validation.cpp</code>, <code>ConnectBlock()</code>:</p>
                <ol>
                    <li>Validates MWEB extension block</li>
                    <li>Extracts contributions from MWEB transactions</li>
                    <li>Removes included transactions from mempool</li>
                    <li>Clears mempool entries for confirmed transactions</li>
                </ol>
            </section>

            <section class="content-section">
                <h2>Validation</h2>
                
                <h3>Transaction Validation</h3>
                <p>When adding an MWEB transaction, <code>AddMWEBTransaction()</code> validates:</p>
                <ul>
                    <li><strong>Balance:</strong> <code>tx.VerifyBalance()</code> - Ensures sum(inputs) = sum(outputs) + fees</li>
                    <li><strong>Range Proofs:</strong> <code>tx.VerifyRangeProofs()</code> - Ensures all amounts are non-negative</li>
                </ul>
                
                <p>If validation fails, the transaction is rejected and not added to mempool.</p>
                
                <h3>Peg-in Validation</h3>
                <p>When adding a peg-in, <code>AddPegIn()</code> validates:</p>
                <ul>
                    <li><strong>Amount:</strong> Must be positive</li>
                    <li><strong>Transaction ID:</strong> Must be non-null</li>
                </ul>
                
                <h3>Peg-out Validation</h3>
                <p>When adding a peg-out, <code>AddPegOut()</code> validates:</p>
                <ul>
                    <li><strong>Amount:</strong> Must be positive</li>
                    <li><strong>Transaction ID:</strong> Must be non-null</li>
                    <li><strong>Commitment:</strong> Must be non-null (valid MWEB output)</li>
                </ul>
            </section>

            <section class="content-section">
                <h2>Memory Management</h2>
                
                <h3>Size Limits</h3>
                <p>The MWEB mempool has no explicit size limits, but:</p>
                <ul>
                    <li><strong>Transaction Size:</strong> Each MWEB transaction includes commitments and range proofs (~1-2 KB)</li>
                    <li><strong>Memory Usage:</strong> Grows with pending transactions</li>
                    <li><strong>Automatic Cleanup:</strong> Transactions removed when included in blocks</li>
                </ul>
                
                <h3>Clear Operations</h3>
                <p>The <code>Clear()</code> method removes all pending transactions:</p>
                <ul>
                    <li>Called during block reorganization</li>
                    <li>Clears all three maps (mweb_txs, peg_ins, peg_outs)</li>
                    <li>Thread-safe operation</li>
                </ul>
            </section>

            <section class="content-section">
                <h2>Usage Examples</h2>
                
                <h3>Adding a Transaction</h3>
                <pre><code>// Create MWEB transaction
CMWEBTransaction mweb_tx;
// ... populate transaction ...

// Add to mempool
extern CMWEBMempool mwebMempool;
if (mwebMempool.AddMWEBTransaction(mweb_tx)) {
    LogPrintf("MWEB transaction added to mempool: %s\n", mweb_tx.tx_hash.ToString());
} else {
    LogPrintf("Failed to add MWEB transaction (validation failed)\n");
}</code></pre>
                
                <h3>Getting Pending Transactions</h3>
                <pre><code>// Get all pending MWEB transactions
extern CMWEBMempool mwebMempool;
std::vector&lt;CMWEBTransaction&gt; pending_txs = mwebMempool.GetMWEBTransactions();

// Get all pending peg-ins
std::vector&lt;CPegInTransaction&gt; pending_peg_ins = mwebMempool.GetPegIns();

// Get all pending peg-outs
std::vector&lt;CPegOutTransaction&gt; pending_peg_outs = mwebMempool.GetPegOuts();</code></pre>
                
                <h3>Removing After Block Inclusion</h3>
                <pre><code>// After block is connected, remove transactions
extern CMWEBMempool mwebMempool;
for (const auto& mweb_tx : block.mweb_extension->mweb_txs) {
    mwebMempool.RemoveMWEBTransaction(mweb_tx.tx_hash);
}
for (const auto& peg_in : block.mweb_extension->peg_ins) {
    mwebMempool.RemovePegIn(peg_in.peg_tx_id);
}
for (const auto& peg_out : block.mweb_extension->peg_outs) {
    mwebMempool.RemovePegOut(peg_out.peg_tx_id);
}</code></pre>
            </section>

            <section class="content-section">
                <h2>Related Documentation</h2>
                <ul>
                    <li><a href="mweb-overview.html">MWEB Overview</a> - General MWEB concepts</li>
                    <li><a href="mweb-operations.html">Peg-in/Peg-out</a> - How peg transactions work</li>
                    <li><a href="mweb-structures.html">MWEB Structures</a> - Data structure details</li>
                    <li><a href="rpc-mweb.html">MWEB RPC</a> - RPC commands for MWEB</li>
                    <li><a href="validation.html">Validation System</a> - How blocks are validated</li>
                </ul>
            </section>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>

